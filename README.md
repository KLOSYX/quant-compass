# 投资策略说明 (Investment Strategy)

本项目核心采用 **Kelly DCA (凯利定投 / 基于均线偏离的价值平均策略)**，旨在通过市场估值信号动态调整仓位，实现"低买高卖"。
> [!NOTE]
> 本策略虽然在 UI 中称为 "Kelly"，但其实际算法更多借鉴了 **价值平均 (Value Averaging)** 的原理，利用均线偏离度来线性调整仓位。

## 策略回测逻辑对比 (Backtest Logic Comparison)

### 1. 攒钱一次投 (Lump Sum)
- **逻辑**: 假设您手头有一笔总资金（例如 10万元），在回测开始的第一天 **全仓买入** 选定的组合。
- **操作**: 只有买入，之后长期持有 (Buy & Hold)，不做任何加减仓或再平衡。
- **适用场景**: 验证在选定时间段被动持有组合的收益表现。

### 2. 月月投 (DCA - Dollar Cost Averaging)
- **逻辑**: 模拟工薪族定投。每月固定日期（如月底）投入 **固定金额** (Budget)。
- **操作**:
    - **定额定比买入**: 每月的新增资金严格按照初始设定的比例（如 50/50）分配买入。
    - **不平衡 (No Rebalancing)**: **不会**根据市场波动调整已有的持仓比例，也不会根据市场估值调整买入金额。
- **特点**: “盲投”。优点是纪律性强，缺点是无法动态应对市场由牛转熊的估值变化。

### 3. VA/Kelly 定投 (Value Averaging / Kelly)
- **逻辑**: **“价值平均策略”**。每月根据市场估值（价格 vs 均线）动态决定买卖金额。
- **操作**:
    - **低估时**: 大幅加仓 (买入金额 > 月预算)。
    - **高估时**: 减少买入，甚至 **卖出** (锁定利润)。
    - **仓位控制**: 默认最大持仓 80% (保留现金抄底)，最小 30%。
- **特点**: 相比 DCA，它能更主动地“低买高卖”，长期平滑波动，但在单边大牛市中可能因为过早减仓而跑输满仓的 DCA。

---

## 4. 回测核心指标说明 (Backtest Metrics)

在回测结果中，您会看到两个不同的“最大回撤”指标，理解差异非常重要：

### 最大回撤 (市值) / Max Drawdown (Market Value)
- **定义**: 基于账户**总资产余额**（Account Balance）计算的从最高点下跌幅度。
- **含义**: 回答“我的账户总金额是不是比之前少了？”
- **DCA/VA 特性**: 对于定投策略，该指标通常**非常低甚至为 0%**。
    - **原因**: 您每个月都在通过“存入新资金”来掩盖亏损。即使市场跌了 10%，只要您新存入的钱够多，总账户余额可能还是创新高的。
- **参考价值**: 较低。它容易让您低估市场风险，产生“我从未亏钱”的错觉。

### 最大回撤 (净值化) / Max Drawdown (NAV)
- **定义**: 基于**策略单位净值 (Strategy Unit NAV)** 计算。采用标准的基金会计法，将策略视为一只基金，您的每次定投视为按当时净值申购份额。
- **含义**: 回答“撇开资金进出的影响，我的投资组合本身的净值曲线表现如何？”
- **DCA/VA 特性**: 能够真实反映策略在市场下跌时的抗风险能力。修正了此前“简单市值/投入”算法中因不断投入资金而导致的计算失真。
- **参考价值**: **极高**。这是评估策略风险的最标准指标。如果该指标显示 -20%，意味着策略净值从最高点回撤了 20%。

> **结论**: 请重点关注 **最大回撤 (净值化)** 来评估策略风险。

---

## VA/Kelly 策略详解

### 1. 市场信号 (Market Signal)
我们使用 **价格与 250日均线 (MA250)** 的偏离程度来判断市场水位。
- **MA250**: 代表过去一年的平均成本。

| 信号                     | 条件                   | 含义                                |
| :----------------------- | :--------------------- | :---------------------------------- |
| **🟢 低估 (Undervalued)** | 当前价格 < MA250 * 0.9 | 价格低于年线10%以上，便宜，机会大。 |
| **🔴 高估 (Overvalued)**  | 当前价格 > MA250 * 1.1 | 价格高于年线10%以上，贵，风险大。   |
| **🟡 中性 (Neutral)**     | 介于两者之间           | 价格正常。                          |

### 2. 目标仓位 (Target Asset Allocation) - 高级加权
不再使用简单的三档位，而是采用 **线性插值 (Linear Interpolation)** 使得仓位调整更加丝滑。

$$
TargetRatio = f(Bias)
$$

其中 $Bias = \frac{Price}{MA250}$。

- **低估区间 ($Bias \le 0.8$)**: 目标仓位维持最高 **80%** (可配置)。
- **高估区间 ($Bias \ge 1.2$)**: 目标仓位降至最低 **30%** (可配置)。
- **中间区间**: 目标仓位在 30% ~ 80% 之间线性平滑过渡。

### 3. 动态再平衡 (Dynamic Rebalancing)
每个月定投时，策略会执行以下步骤：
1.  **计算总财富**: `当前基金市值 + 当前现金 + 本月新投入预算`。
2.  **计算目标市值**: `总财富 * 目标仓位比例`。
3.  **计算差额 (Gap)**: `目标市值 - 当前基金市值`。
4.  **执行操作(引入限制)**:
    - **买入限制**: 单次买入金额不超过 `月定投预算 * max_buy_multiplier` (默认 3.0倍)，防止资金耗尽过快。
    - **卖出阈值**: 只有当 `Gap` 偏差超过总资产的 `sell_threshold` (默认 5%) 时才执行卖出，避免频繁交易磨损。

### 5. 高级参数 (Advanced Settings)
- **Max Buy Multiplier (最大买入倍数)**: 限制单次抄底的最大力度。
- **Sell Threshold (卖出阈值)**: 避免微小波动触发卖出。
- **Min/Max Weight (最小/最大持仓)**: 自定义您的激进/保守程度。
- **Buy/Sell Fee (申购/赎回费率)**: 考虑真实交易成本，使回测和建议更精准。
- **MA Window (均线窗口)**: 自定义 MA 的回溯长度（默认 12个月，约等于 250日线）。



---

### 为什么会出现"买入 0 元"?
当市场**严重高估**且您的**持仓已经很重**时，策略会判断您持有的风险资产太多了。
为了安全，策略会建议：
1.  **暂停买入**: 本月的预算全部存起来，不要追高。
2.  **卖出**: 如果高估太严重，甚至会建议您卖出部分持仓锁定利润。

这就是为什么有时候能在推荐表中看到 `无风险资产: 存入 ¥20,000` (即您的全部月预算)。

### 常见问题 (FAQ)

#### Q1: "选择目标组合" 到底决定了什么？
点击有效前沿上的点，决定了您投资组合中 **风险资产内部的配比权重**（例如：50% 沪深300 + 50% 标普500）。
- **Lump Sum / DCA**: 会严格按照这个比例去分配每一笔买入资金。
- **VA/Kelly**: 会把这个比例作为风险资产部分的**基准目标**，并在此基础上根据市场估值调整总仓位（股票 vs 现金）。

#### Q2: 为什么最终回测收益率 != 我选的"预期回报率"？
图表上的"预期回报率"是基于历史数据的**长期统计平均值**（年化），代表该组合的理论长期表现。
而**最终回测收益率**是您在**特定回测时间段**（例如过去3年）内实际定投出来的真实结果。
- **时间段差异**: 过去3年可能是大牛市（收益 > 预期）或熊市（收益 < 预期）。
- **资金占用**: VA/Kelly 策略会持有现金（Cash Drag），因此在牛市中其收益率通常会低于全仓股票的理论预期值，这是为了换取更低的回撤。

#### Q3: "策略前沿 (Strategy Frontier)" 是什么？
- **理论预期 (Theoretical)**: 经典的马科维茨有效前沿，基于资产本身的历史收益率和协方差矩阵计算得出。它假设资金全额投入且不进行择时。
- **策略实测 (Strategy Actual)**:
    - 我们对前沿上的每一个点（代表一种特定的资产权重组合）都实际运行了一遍 VA/Kelly 策略回测。
    - 图上的红色点展示的是该权重下，**VA/Kelly 策略真实跑出来的年化回报和实际波动率**。
    - 这条曲线通常位于理论曲线下方（因为有现金拖累），但能更真实地反映您在该策略下能获得的实际风险收益特征，**消除"理论很丰满，现实很骨感"的预期差**。

#### Q4: 回测中的"年化收益率"是如何计算的？
为了公平对比不同策略，我们在"最终回测对比"中统一使用**年化收益率 (Annualized Return)**：
- **Lump Sum (一次性投入)**: 使用 **CAGR (复合年增长率)** 公式。
    $$ CAGR = (\frac{FinalValue}{InitialInvestment})^{\frac{1}{Years}} - 1 $$
- **DCA / VA (定投类)**: 由于资金是分批投入的，资金的平均占用时间约为总时长的一半。为了直观对比，我们使用近似公式：
    $$ Annualized \approx (1 + TotalReturn)^{\frac{1}{Years/2}} - 1 $$
    *注：这比简单的累计收益率更能反映资金的使用效率。*
